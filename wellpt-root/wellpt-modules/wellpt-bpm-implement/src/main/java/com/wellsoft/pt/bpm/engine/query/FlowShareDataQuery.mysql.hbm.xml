<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE hibernate-mapping PUBLIC "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
        "http://www.hibernate.org/dtd/hibernate-mapping-3.0.dtd">
<hibernate-mapping>
    <sql-query name="getBranchTaskShareDataQuery">
        <![CDATA[
		select t1.uuid                    as task_inst_uuid,
		       t1.flow_inst_uuid          as flow_inst_uuid,
		       t1.form_uuid               as form_uuid,
		       t1.data_uuid               as data_uuid,
		       t3.todo_id                 as todo_id,
		       t3.todo_name               as todo_name,
		       t1.id                      as current_task_id,
		       t1.name                    as current_task_name,
		       t1.todo_user_id            as current_todo_user_id,
		       t1.todo_user_name          as current_todo_user_name,
		       t1.due_time                as due_time,
		       t4.limit_unit			  as limit_unit,
		       t4.timer_uuid			  as timer_uuid,
		       t2.id                      as flow_def_id,
		       t3.branch_type             as branch_type,
		       case when t3.branch_type = '2' then 1 else 0 end             as is_major,
		       t3.is_share                as is_share,
		       t3.completion_state        as completion_state,
		       t3.parallel_task_id        as belong_to_task_id,
		       t3.parallel_task_inst_uuid as belong_to_task_inst_uuid,
		       t3.flow_inst_uuid          as belong_to_flow_inst_uuid,
		       1                          as dispatch_state
		  from wf_task_instance t1
		  left join wf_flow_instance t2
		    on t1.flow_inst_uuid = t2.uuid
		 inner join wf_task_branch t3
		    on t1.flow_inst_uuid = t3.flow_inst_uuid
		   and t1.uuid = t3.current_task_inst_uuid
	   	 left join (select wt2.flow_inst_uuid, wt2.task_inst_uuid, wt2.limit_unit, wt2.timer_uuid
					from wf_task_timer wt2
					left join (
						select max(wt3.modify_time) as max_modify_time, wt3.task_inst_uuid
						from wf_task_timer wt3
						group by wt3.task_inst_uuid
					) wt3 on wt2.task_inst_uuid = wt3.task_inst_uuid
					where wt2.modify_time = wt3.max_modify_time) t4
     		on t3.current_task_inst_uuid = t4.task_inst_uuid
		 where t1.type = 1 and t1.flow_inst_uuid = :flowInstUuid
		 order by is_major desc, t3.branch_type desc, t1.create_time desc
	]]>
    </sql-query>

    <sql-query name="getTodoUserNameByParentTaskInstUuid">
        select
        t.parent_task_inst_uuid,
        max(t.uuid),
        group_concat(t.todo_user_name, ',')
        from
        wf_task_instance t
        where
        t.suspension_state = 0
        and t.parent_task_inst_uuid in(:parentTaskInstUuids)
        group by
        t.parent_task_inst_uuid
    </sql-query>

    <sql-query name="getFlowShareData">
        <![CDATA[
		select t1.uuid                  as task_inst_uuid,
		       t1.flow_inst_uuid        as flow_inst_uuid,
		       t1.form_uuid        		as form_uuid,
		       t1.data_uuid        		as data_uuid,
		       t1.start_time            as start_time,
		       t3.todo_id               as todo_id,
		       t3.todo_name             as todo_name,
		       t1.id                    as current_task_id,
		       t1.name                  as current_task_name,
		       t1.todo_user_id          as current_todo_user_id,
		       t1.todo_user_name        as current_todo_user_name,
		       t2.timing_state    		as timing_state,
		       t2.due_time              as due_time,
		       t4.limit_unit			as limit_unit,
		       t4.timer_uuid			as timer_uuid,
		       t3.flow_id			    as flow_def_id,
		       t3.is_major              as is_major,
		       t3.is_share              as is_share,
		       t3.is_wait               as is_wait,
		       t3.completion_state      as completion_state,
		       t3.parent_task_id        as belong_to_task_id,
		       t3.parent_task_inst_uuid as belong_to_task_inst_uuid,
		       t3.parent_flow_inst_uuid as belong_to_flow_inst_uuid
		       <if isNotBlank( leftJoinSql )>
       		  	,
       		  	l.extraColumn0,
				l.extraColumn1,
				l.extraColumn2,
				l.extraColumn3,
				l.extraColumn4,
				l.extraColumn5,
				l.extraColumn6,
				l.extraColumn7,
				l.extraColumn8,
				l.extraColumn9
       		  	</if>
		  from wf_task_instance t1
		  left join wf_flow_instance t2
		    on t1.flow_inst_uuid = t2.uuid
		  left join wf_task_sub_flow t3
		    on t1.flow_inst_uuid = t3.flow_inst_uuid
		  left join (select wt2.flow_inst_uuid, wt2.task_inst_uuid, wt2.limit_unit, wt2.timer_uuid
					from wf_task_timer wt2
					left join (
						select max(wt3.modify_time) as max_modify_time, wt3.task_inst_uuid
						from wf_task_timer wt3
						group by wt3.task_inst_uuid
					) wt3 on wt2.task_inst_uuid = wt3.task_inst_uuid
					where wt2.modify_time = wt3.max_modify_time) t4
     		on t1.uuid = t4.task_inst_uuid
     		<if isNotBlank( leftJoinSql )>
		   		left join
		   		 (
		   		 	SELECT
						wl.uuid,
						group_concat(wl.extraColumn0 SEPARATOR '') AS extraColumn0,
						group_concat(wl.extraColumn1 SEPARATOR '') AS extraColumn1,
						group_concat(wl.extraColumn2 SEPARATOR '') AS extraColumn2,
						group_concat(wl.extraColumn3 SEPARATOR '') AS extraColumn3,
						group_concat(wl.extraColumn4 SEPARATOR '') AS extraColumn4,
						group_concat(wl.extraColumn5 SEPARATOR '') AS extraColumn5,
						group_concat(wl.extraColumn6 SEPARATOR '') AS extraColumn6,
						group_concat(wl.extraColumn7 SEPARATOR '') AS extraColumn7,
						group_concat(wl.extraColumn8 SEPARATOR '') AS extraColumn8,
						group_concat(wl.extraColumn9 SEPARATOR '') AS extraColumn9
					 from
		   		 (${leftJoinSql})wl group by wl.uuid) l on t2.data_uuid = l.uuid
		   </if>
		 where t1.suspension_state = :suspension_state
		   and t1.parent_task_inst_uuid in
		       (select t.parent_task_inst_uuid
		          from wf_task_sub_flow t
		         where t.parent_flow_inst_uuid = :parent_flow_inst_uuid)
		   <if isNotBlank( belongToTaskInstUuid )>
		 		and t3.parent_task_inst_uuid = :belongToTaskInstUuid
		   </if>
		   <if isNotBlank( keyword )>
		   		and (${keywordSql})
		   </if>
		   <if isBlank( orderBySql )>
		 	order by t1.name,t3.is_major desc, t2.create_time desc
		 	</if>
		 	<if isNotBlank( orderBySql )>
		 	 ${orderBySql}
		 	</if>
	]]>
    </sql-query>

    <sql-query name="getFlowShareDataBySubFlowInstUuid">
        <![CDATA[
		 select t1.uuid                  as task_inst_uuid,
		        t1.flow_inst_uuid        as flow_inst_uuid,
		        t1.form_uuid        	 as form_uuid,
		      	t1.data_uuid             as data_uuid,
		        t3.todo_id               as todo_id,
		        t3.todo_name             as todo_name,
		        t1.id                    as current_task_id,
		        t1.name                  as current_task_name,
		        t1.todo_user_id          as current_todo_user_id,
		        t1.todo_user_name        as current_todo_user_name,
		        t2.due_time              as due_time,
		        t2.timing_state    		as timing_state,
		        t3.flow_id			     as flow_def_id,
		        t3.is_major              as is_major,
		        t3.is_share              as is_share,
		        t3.is_wait               as is_wait,
		        t3.completion_state   	 as completion_state,
		        t3.parent_task_id        as belong_to_task_id,
		        t3.parent_task_inst_uuid as belong_to_task_inst_uuid,
		        t3.parent_flow_inst_uuid as belong_to_flow_inst_uuid
		        <if isNotBlank( leftJoinSql )>
       		  	,extraColumn0,extraColumn1,extraColumn2,extraColumn3,extraColumn4,extraColumn5,extraColumn6,extraColumn7,
       		  	extraColumn8,extraColumn9
       		  	</if>
		   from wf_task_instance t1
		   left join wf_flow_instance t2
		     on t1.flow_inst_uuid = t2.uuid
		   left join wf_task_sub_flow t3
		     on t1.flow_inst_uuid = t3.flow_inst_uuid
		     <if isNotBlank( leftJoinSql )>
		   		left join
		   		 (select uuid,GROUP_CONCAT(extraColumn0 SEPARATOR  '') extraColumn0,
					GROUP_CONCAT(extraColumn1 SEPARATOR  '') extraColumn1,
					GROUP_CONCAT(extraColumn2 SEPARATOR  '') extraColumn2,
					GROUP_CONCAT(extraColumn3 SEPARATOR  '') extraColumn3,
					GROUP_CONCAT(extraColumn4 SEPARATOR  '') extraColumn4,
					GROUP_CONCAT(extraColumn5 SEPARATOR  '') extraColumn5,
					GROUP_CONCAT(extraColumn6 SEPARATOR  '') extraColumn6,
					GROUP_CONCAT(extraColumn7 SEPARATOR  '') extraColumn7,
					GROUP_CONCAT(extraColumn8 SEPARATOR  '') extraColumn8,
					GROUP_CONCAT(extraColumn9 SEPARATOR  '') extraColumn9
					 from
		   		 (${leftJoinSql}) group by uuid) l on t2.data_uuid = l.uuid
		   </if>
		  where t1.suspension_state = :suspension_state
		    and t1.parent_task_inst_uuid in
		        (select t.parent_task_inst_uuid
		           from wf_task_sub_flow t
		          where exists
		          (select f.uuid
		                   from wf_task_sub_flow f
		                  where f.flow_inst_uuid = :sub_flow_inst_uuid
		                    and t.parent_flow_inst_uuid = f.parent_flow_inst_uuid))
		  	<if isNotBlank( keyword )>
		   		and (${keywordSql})
		    </if>
		  	<if isBlank( orderBySql )>
		 	order by t1.name,t3.is_major desc, t2.create_time desc
		 	</if>
		 	<if isNotBlank( orderBySql )>
		 	 ${orderBySql}
		 	</if>
	]]>
    </sql-query>
</hibernate-mapping>