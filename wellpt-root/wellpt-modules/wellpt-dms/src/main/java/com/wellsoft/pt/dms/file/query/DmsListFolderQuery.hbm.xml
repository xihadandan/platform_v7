<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE hibernate-mapping PUBLIC "-//Hibernate/Hibernate Mapping DTD 3.0//EN"
        "http://www.hibernate.org/dtd/hibernate-mapping-3.0.dtd">
<hibernate-mapping>
    <sql-query name="dmsListFolderQuery">
        <![CDATA[
        select * from (
            select  t1.uuid 				as uuid,
                    t1.name 				as name,
                    t1.code 				as code,
                    'application/folder'	as content_type,
                    0 						as file_size,
                    '' 						as data_def_uuid,
                    '' 						as data_uuid,
                    t1.parent_uuid			as folder_uuid,
                    t1.status				as status,
                    t1.creator 				as creator,
                    t3.user_name 			as creator_name,
                    t1.create_time 			as create_time,
                    t1.modifier				as modifier,
                    t1.modify_time 			as modify_time
            from dms_folder t1
                     left join dms_folder_configuration t2 on t1.uuid = t2.folder_uuid
                     left join user_info t3 on t1.creator = t3.user_id
            where t1.parent_uuid = :folderUuid and t1.status <> '0'
                and exists(
                    select distinct oar.object_identity_uuid
                    from dms_object_assign_role oar,
                         dms_object_assign_role_item oari,
                         dms_role r,
                         dms_role_action ra
                         <if sids?? && (sids?size > 1000)>,
                            (${userOrgIdsTemplate}) u_ -- 用户相关ID
                         </if>
                    where oar.uuid = oari.assign_role_uuid
                      and oar.role_uuid = r.uuid
                      and r.uuid = ra.role_uuid
                      and ra.action = 'readFolder'
                      <if sids?? && (sids?size > 1000)>
                        and oari.org_id = u_.org_id
                      <else>
                        and oari.org_id in(:sids)
                      </if>
                      and oar.object_identity_uuid = t2.ref_object_identity_uuid
                )
        ) t where 1 = 1
            <if isNotBlank(whereSql)>
                and ${whereSql}
            </if>
            <if isNotBlank(orderString)>
                ${orderString}
            <else>
                order by t.code asc
            </if>
        ]]>
    </sql-query>

    <sql-query name="dmsListFolderQueryWithoutPermission">
        <![CDATA[
		select t.*
		    from (
			select	f1.uuid 				as uuid,
	                f1.name 				as name,
	                f1.code 				as folder_code,
	                'application/folder'	as content_type,
	                0 						as file_size,
	                '' 						as data_def_uuid,
	                '' 						as data_uuid,
	                f1.parent_uuid			as folder_uuid,
	                f1.status				as status,
	                f1.creator 				as creator,
	                f1.create_time 			as create_time,
		  			f1.modifier				as modifier,
		     		f1.modify_time 			as modify_time
			  from dms_folder f1 left join user_info t3 on f1.creator = t3.user_id
			 where f1.parent_uuid = :folderUuid and f1.status <> '0'
			   	<if isNotBlank(folderOrderString)>
	   				${folderOrderString}
	   			</if>
			 	<if isBlank(folderOrderString)>
	   				order by f1.code asc, f1.name asc
	   			</if>
		) t where 1 = 1
	   		<if isNotBlank(whereSql)>
	   			and ${whereSql}
	   		</if>
	]]>
    </sql-query>

    <sql-query name="dmsListDeletedFolderQueryWithoutPermission">
        <![CDATA[
		select t.*
		    from (
			select	f1.uuid 				as uuid,
	                f1.name 				as name,
	                f1.code 				as folder_code,
	                'application/folder'	as content_type,
	                0 						as file_size,
	                '' 						as data_def_uuid,
	                '' 						as data_uuid,
	                f1.parent_uuid			as folder_uuid,
	                f1.status				as status,
	                f1.creator 				as creator,
	                t3.creator_name	    	as creator_name,
	                f1.create_time 			as create_time,
		  			f1.modifier				as modifier,
		     		f1.modify_time 			as modify_time
			  from dms_folder f1 left join user_info t3 on f1.creator = t3.user_id
			 where f1.parent_uuid = :folderUuid and f1.status = '0'
			   	<if isNotBlank(folderOrderString)>
	   				${folderOrderString}
	   			</if>
			 	<if isBlank(folderOrderString)>
	   				order by f1.code asc, f1.name asc
	   			</if>
		) t where 1 = 1
	   		<if isNotBlank(whereSql)>
	   			and ${whereSql}
	   		</if>
	]]>
    </sql-query>

    <sql-query name="dmsListRootFolderQuery">
        <![CDATA[
        select * from (
            select  t1.uuid 				as uuid,
                    t1.name 				as name,
                    t1.code 				as code,
                    'application/folder'	as content_type,
                    0 						as file_size,
                    '' 						as data_def_uuid,
                    '' 						as data_uuid,
                    t1.parent_uuid			as folder_uuid,
                    t1.status				as status,
                    t1.creator 				as creator,
                    t3.user_name 			as creator_name,
                    t1.create_time 			as create_time,
                    t1.modifier				as modifier,
                    t1.modify_time 			as modify_time
            from dms_folder t1
                     left join dms_folder_configuration t2 on t1.uuid = t2.folder_uuid
                     left join user_info t3 on t1.creator = t3.user_id
            where t1.parent_uuid is null and t1.type = 0 and t1.status <> '0'
                <if isNotBlank(systemId)>
                    and t1.system = :systemId
                </if>
                and exists(
                    select distinct oar.object_identity_uuid
                    from dms_object_assign_role oar,
                         dms_object_assign_role_item oari,
                         dms_role r,
                         dms_role_action ra
                         <if sids?? && (sids?size > 1000)>,
                            (${userOrgIdsTemplate}) u_ -- 用户相关ID
                         </if>
                    where oar.uuid = oari.assign_role_uuid
                      and oar.role_uuid = r.uuid
                      and r.uuid = ra.role_uuid
                      and ra.action = 'readFolder'
                      <if sids?? && (sids?size > 1000)>
                        and oari.org_id = u_.org_id
                      <else>
                        and oari.org_id in(:sids)
                      </if>
                      and oar.object_identity_uuid = t2.ref_object_identity_uuid
                )
        ) t where 1 = 1
            <if isNotBlank(whereSql)>
                and ${whereSql}
            </if>
            <if isNotBlank(orderString)>
                ${orderString}
            </if>
        ]]>
    </sql-query>
</hibernate-mapping>